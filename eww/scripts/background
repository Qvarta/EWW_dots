#!/bin/bash

# @requires: imagemagick

source $HOME/.config/eww/var.conf
cache_folder="/tmp/eww/thumbnails"

create_thumbnails(){
    if [ ! -d "$cache_folder" ]; then
        mkdir -p "$cache_folder"
    fi

    for file in $SET_BG/*; do
        extension="${file##*.}"
        extension_lc="${extension,,}"

        # Check if the file has a valid extension
        if [[ "$extension_lc" == "jpg" || "$extension_lc" == "jpeg" || "$extension_lc" == "png" ]]; then
            destination="$cache_folder/$(basename "$file")"
            if [ ! -e "$destination" ]; then
                convert "$file" -resize 10% "$destination"
            fi
        fi
    done
}
get_bg(){
    json="["
    first="true"

    for file in $SET_BG/*; do
        if [ -f "$file" ]; then
            if [ "$first" = "true" ]; then
                json+="{\"style\":\"background-image: url('$cache_folder/$(basename "$file")')\", \"path\":\"$SET_BG$(basename "$file")\"}"
                first="false"
            else
                json+=",{\"style\":\"background-image: url('$cache_folder/$(basename "$file")')\", \"path\":\"$SET_BG$(basename "$file")\"}"
            fi
        fi
    done

    json+="]"
    echo $json | jq -r .
}
chg_bg(){
    swww img $1
}
case $1 in
    cache)
        create_thumbnails
        ;;
    get)
        get_bg
        ;;
    set)
        chg_bg $2
        ;;
esac