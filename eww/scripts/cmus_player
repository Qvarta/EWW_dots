#!/bin/bash

temp_folder="/tmp"
default_style="background-image: url('images/ui/default.jpg');"

check_available() {
  # [ ! pgrep -x "cmus" > /dev/null ] && echo "off" || echo "on"
  if ! pgrep -x "cmus" > /dev/null; then
    echo "off"
  else
    echo "on"
  fi
}
get_status() {
  echo $(cmus-remote -C status | grep status | awk {'print $2'})
}
get_tag(){
    tag=$(cmus-remote -Q | grep -w "tag $1" | cut -d ' ' -f 3-)
    echo $tag
}
get_abs_duration(){
    echo $(cmus-remote -Q | grep -w "duration" | awk '{ print $2}')
}
get_abs_position(){
  abs_position=$(cmus-remote -Q | grep -w "position" | awk '{ print $2}')
  if [[ $abs_position -le 2 ]]; then
    get_cover
  fi
  echo $abs_position
}
convert(){
  abs_value=$(cmus-remote -Q | grep -w "$1" | awk '{ print $2}')
  minutes=$((abs_value / 60))
  seconds=$((abs_value % 60))
  if [ $seconds -lt 10 ]; then
      converted_value="${minutes}:0${seconds}"
  else
      converted_value="${minutes}:${seconds}"
  fi
  echo $converted_value 
}
get_cover(){
  mp3_file=`cmus-remote -Q | grep "file" | awk -F 'file ' '{print $2}'`
  rm -f "$temp_folder/cover.jpg"
  ffmpeg -i "$mp3_file" -an -vcodec copy "$temp_folder/cover.jpg" 2>/dev/null 
}
get_style(){
  style=$([ -e "$temp_folder/cover.jpg" ] && echo "background-image: url('$temp_folder/cover.jpg');" || echo $default_style)
  echo $style
}
track_info(){
  if [[ $(check_available) == "on" ]]; then
    local json=$(jq -n \
      --arg available "$(check_available)" \
      --arg status "$(get_status)" \
      --arg title "$(get_tag title)" \
      --arg artist "$(get_tag artist)" \
      --arg album "$(get_tag album)" \
      --arg abs_duration "$(get_abs_duration)" \
      --arg duration "$(convert $(get_abs_duration))" \
      --arg abs_position "$(get_abs_position)" \
      --arg position "$(convert $(get_abs_position))" \
      --arg style "$(get_style)" \
      '{available: $available, status: $status, title: $title, artist: $artist, album: $album, album: $album, abs_duration: $abs_duration, abs_position: $abs_position, duration: $duration, position: $position, style: $style}')
  else
    local json=$(jq -n --arg available "$(check_available)" '{available: $available}')
  fi
  echo "$json" | jq -r .
}
track_info
