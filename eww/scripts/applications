#!/bin/bash

icon_dir="$HOME/.icons/Gruvbox/48/apps"
desktop_dir="/usr/share/applications"
temp_folder="/tmp/eww"
tmp_file="applications.json"
terminal="kitty"
hide=("Avahi" "Wayland" "lstopo" "Qt" "About" "Icon Browser" "YAD settings" "Vim")

get_name() {
    local desktop_file="$1"
    awk -F= '/^\[Desktop Entry\]$/ { in_section=1; next } /^\[.*\]$/ { in_section=0 } in_section && /^Name=/ { print $2 }' "$desktop_file"
}
get_exec() {
    local desktop_file="$1"
    awk -F= '/^\[Desktop Entry\]$/ { in_section=1; next } /^\[.*\]$/ { in_section=0 } in_section && /^Exec=/ { print $2 }' "$desktop_file"
}
get_icon() {
    local desktop_file="$1"
    awk -F= '/^\[Desktop Entry\]$/ { in_section=1; next } /^\[.*\]$/ { in_section=0 } in_section && /^Icon=/ { print $2 }' "$desktop_file"
}
get_icon_path() (
    local icon_name="$1"
    found_file=$(find -L "$icon_dir" -type f -name "*$icon_name*" -print -quit)
    if [ -n "$found_file" ]; then
        echo $found_file
    else
        echo "None"
    fi
)
get_comment() {
    local desktop_file="$1"
    awk -F= '/^\[Desktop Entry\]$/ { in_section=1; next } /^\[.*\]$/ { in_section=0 } in_section && /^Comment=/ { print $2 }' "$desktop_file"
}
get_comment_ru() {
    local desktop_file="$1"
    awk -F= '/^\[Desktop Entry\]$/ { in_section=1; next } /^\[.*\]$/ { in_section=0 } in_section && /^Comment\[ru\]=/ { print $2 }' "$desktop_file"
}
create_app_list(){
    local json_array=()
    for desktop_file in "$desktop_dir"/*.desktop; do
        # Проверка, существует ли файл
        if [ -e "$desktop_file" ]; then
            # Проверка наличия строки NoDisplay=true в файле .desktop
            if ! grep -q "NoDisplay=true" "$desktop_file"; then
                name=$(get_name "$desktop_file")
                desktop=$(basename $desktop_file)
                icon=$(get_icon "$desktop_file")
                icon_path=$(get_icon_path "$icon")
                comment=$(get_comment "$desktop_file")
                comment_ru=$(get_comment_ru "$desktop_file") 
                if ! grep -q "Terminal=true" "$desktop_file"; then
                    command="gtk-launch $desktop" 
                else
                    exec=$(get_exec "$desktop_file")
                    command="$terminal $exec" 
                fi        
                # Проверка, содержит ли Name подстроки из массива hide
                skip=false
                for substring in "${hide[@]}"; do
                    if [[ "$name" == *"$substring"* ]]; then
                        skip=true
                        break
                    fi
                done

                # Если не содержит подстроки из hide и не пустые, то добавляем в JSON-массив
                if [ "$skip" == false ] && [ -n "$name" ] && [ -n "$exec" ]; then
                    json_array+=("{\"app\":\"$name\", \"icon_name\":\"$icon\", \"icon\":\"$icon_path\", \"path\":\"$desktop\",\"en\":\"$comment\",\"ru\":\"$comment_ru\", \"command\":\"$command\"}")
                fi
            fi
        fi
    done
    if [ -d "$temp_folder" ]; then
         mkdir -p "$temp_folder"
    fi
    rm -f "$temp_folder/$tmp_file"
    echo "["$(IFS=,; echo "${json_array[*]}")"]" >> $temp_folder/$tmp_file
}
get_app_list(){
    local app_json=$(cat $temp_folder/$tmp_file)
    echo $app_json | jq -r .
}
case "$1" in
  "create")
    create_app_list
    ;;
  "get")
    get_app_list
    ;;
esac